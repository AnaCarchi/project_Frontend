// app/services/reportService.js - VERSI√ìN CORREGIDA COMPLETA

import api from './api';
import { Alert, Platform } from 'react-native';
import * as FileSystem from 'expo-file-system';
import * as Sharing from 'expo-sharing';
import * as MediaLibrary from 'expo-media-library';

export const reportService = {
  // Solicitar permisos para guardar en almacenamiento
  requestStoragePermissions: async () => {
    try {
      if (Platform.OS === 'android') {
        const { status } = await MediaLibrary.requestPermissionsAsync();
        return status === 'granted';
      }
      return true;
    } catch (error) {
      console.error('Error requesting storage permissions:', error);
      return false;
    }
  },

  // Generar reporte de productos PDF - CORREGIDO
  generateProductsPdfReport: async () => {
    try {
      console.log('üìä Generando reporte PDF de productos...');
      
      const response = await api.get('/reports/products/pdf/mobile', {
        timeout: 120000, // 2 minutos para reportes
      });
      
      console.log('üìã Response status:', response.status);
      console.log('üìã Response data keys:', Object.keys(response.data || {}));
      
      if (response.data && response.data.success) {
        await reportService.handleReportDownload(response.data, 'PDF de Productos');
        return response.data;
      } else {
        throw new Error('Error en la respuesta del servidor');
      }
    } catch (error) {
      console.error('‚ùå Error generating PDF report:', error);
      
      let errorMessage = 'Error generando reporte PDF';
      if (error.response?.data?.message) {
        errorMessage = error.response.data.message;
      } else if (error.message) {
        errorMessage = error.message;
      }
      
      Alert.alert('Error', errorMessage);
      throw error;
    }
  },

  // Generar reporte de productos Excel - CORREGIDO
  generateProductsExcelReport: async () => {
    try {
      console.log('üìä Generando reporte Excel de productos...');
      
      const response = await api.get('/reports/products/excel/mobile', {
        timeout: 120000, // 2 minutos para reportes
      });
      
      if (response.data && response.data.success) {
        await reportService.handleReportDownload(response.data, 'Excel de Productos');
        return response.data;
      } else {
        throw new Error('Error en la respuesta del servidor');
      }
    } catch (error) {
      console.error('‚ùå Error generating Excel report:', error);
      
      let errorMessage = 'Error generando reporte Excel';
      if (error.response?.data?.message) {
        errorMessage = error.response.data.message;
      } else if (error.message) {
        errorMessage = error.message;
      }
      
      Alert.alert('Error', errorMessage);
      throw error;
    }
  },

  // Generar reporte de categor√≠as PDF - CORREGIDO
  generateCategoriesPdfReport: async () => {
    try {
      console.log('üìä Generando reporte PDF de categor√≠as...');
      
      const response = await api.get('/reports/categories/pdf/mobile', {
        timeout: 120000,
      });
      
      if (response.data && response.data.success) {
        await reportService.handleReportDownload(response.data, 'PDF de Categor√≠as');
        return response.data;
      } else {
        throw new Error('Error en la respuesta del servidor');
      }
    } catch (error) {
      console.error('‚ùå Error generating categories PDF report:', error);
      
      Alert.alert('Error', 'No se pudo generar el reporte de categor√≠as');
      throw error;
    }
  },

  // Generar reporte de usuarios Excel - CORREGIDO
  generateUsersExcelReport: async () => {
    try {
      console.log('üìä Generando reporte Excel de usuarios...');
      
      const response = await api.get('/reports/users/excel/mobile', {
        timeout: 120000,
      });
      
      if (response.data && response.data.success) {
        await reportService.handleReportDownload(response.data, 'Excel de Usuarios');
        return response.data;
      } else {
        throw new Error('Error en la respuesta del servidor');
      }
    } catch (error) {
      console.error('‚ùå Error generating users Excel report:', error);
      
      Alert.alert('Error', 'No se pudo generar el reporte de usuarios');
      throw error;
    }
  },

  // Generar reporte de inventario PDF - CORREGIDO
  generateInventoryReport: async () => {
    try {
      console.log('üìä Generando reporte PDF de inventario...');
      
      const response = await api.get('/reports/inventory/pdf/mobile', {
        timeout: 120000,
      });
      
      if (response.data && response.data.success) {
        await reportService.handleReportDownload(response.data, 'PDF de Inventario');
        return response.data;
      } else {
        throw new Error('Error en la respuesta del servidor');
      }
    } catch (error) {
      console.error('‚ùå Error generating inventory PDF report:', error);
      
      Alert.alert('Error', 'No se pudo generar el reporte de inventario');
      throw error;
    }
  },

  // Determinar directorio de descarga seg√∫n la plataforma - CORREGIDO
  getDownloadDirectory: async () => {
    try {
      // Usar documentDirectory que es accesible en ambas plataformas
      const downloadDir = FileSystem.documentDirectory + 'CatalogoRopa/Reportes/';
      
      const dirInfo = await FileSystem.getInfoAsync(downloadDir);
      if (!dirInfo.exists) {
        await FileSystem.makeDirectoryAsync(downloadDir, { intermediates: true });
        console.log('üìÅ Directorio creado:', downloadDir);
      }
      
      return downloadDir;
    } catch (error) {
      console.error('‚ùå Error getting download directory:', error);
      return FileSystem.documentDirectory;
    }
  },

  // Guardar archivo en almacenamiento - CORREGIDO
  saveToStorage: async (fileName, base64Data) => {
    try {
      console.log('üíæ Guardando archivo:', fileName);
      
      // Guardar en directorio de documentos de la app
      const downloadDir = await reportService.getDownloadDirectory();
      const fileUri = downloadDir + fileName;
      
      await FileSystem.writeAsStringAsync(fileUri, base64Data, {
        encoding: FileSystem.EncodingType.Base64,
      });
      
      console.log('‚úÖ Archivo guardado en:', fileUri);
      
      // Verificar que el archivo se guard√≥ correctamente
      const fileInfo = await FileSystem.getInfoAsync(fileUri);
      if (!fileInfo.exists) {
        throw new Error('El archivo no se guard√≥ correctamente');
      }
      
      console.log('üìÑ Info del archivo:', {
        size: fileInfo.size,
        exists: fileInfo.exists,
        uri: fileInfo.uri,
      });
      
      // En Android, intentar tambi√©n guardar en galer√≠a/downloads
      if (Platform.OS === 'android') {
        try {
          const hasPermission = await reportService.requestStoragePermissions();
          if (hasPermission) {
            const asset = await MediaLibrary.createAssetAsync(fileUri);
            
            // Crear o encontrar √°lbum
            const albumName = 'Cat√°logo Ropa - Reportes';
            let album = await MediaLibrary.getAlbumAsync(albumName);
            
            if (!album) {
              album = await MediaLibrary.createAlbumAsync(albumName, asset);
              console.log('üì± √Ålbum creado:', albumName);
            } else {
              await MediaLibrary.addAssetsToAlbumAsync([asset], album);
              console.log('üì± Archivo agregado al √°lbum:', albumName);
            }
            
            return { internalUri: fileUri, publicUri: asset.uri };
          }
        } catch (publicError) {
          console.log('‚ö†Ô∏è No se pudo guardar en almacenamiento p√∫blico:', publicError.message);
        }
      }
      
      return { internalUri: fileUri, publicUri: null };
      
    } catch (error) {
      console.error('‚ùå Error saving file:', error);
      throw error;
    }
  },

  // Manejar descarga y compartir archivo - CORREGIDO
  handleReportDownload: async (reportData, reportType = 'Reporte') => {
    try {
      const { fileName, base64Data, mimeType, size } = reportData;
      
      console.log('üì• Procesando descarga:', {
        fileName,
        size: `${(size / 1024).toFixed(1)} KB`,
        type: reportType,
      });
      
      // Validar datos
      if (!fileName || !base64Data) {
        throw new Error('Datos del reporte incompletos');
      }
      
      // Guardar archivo
      const savedFile = await reportService.saveToStorage(fileName, base64Data);
      
      // Verificar que se guard√≥
      const fileInfo = await FileSystem.getInfoAsync(savedFile.internalUri);
      if (!fileInfo.exists) {
        throw new Error('Error al guardar el archivo');
      }
      
      // Mostrar mensaje de √©xito con opciones
      const isInPublicStorage = !!savedFile.publicUri;
      const locationMessage = isInPublicStorage 
        ? 'üì± Guardado en: Galer√≠a > Cat√°logo Ropa - Reportes'
        : 'üìÅ Guardado en la carpeta de documentos de la app';
      
      Alert.alert(
        `${reportType} Generado`,
        `‚úÖ ${fileName}\nüìä Tama√±o: ${(size / 1024).toFixed(1)} KB\n\n${locationMessage}`,
        [
          {
            text: 'Compartir',
            onPress: () => reportService.shareFile(savedFile.internalUri, fileName),
          },
          {
            text: 'Ver Ubicaci√≥n',
            onPress: () => reportService.showFileLocation(savedFile.internalUri, isInPublicStorage),
          },
          {
            text: 'OK',
            style: 'default',
          },
        ]
      );
      
    } catch (error) {
      console.error('‚ùå Error procesando descarga:', error);
      Alert.alert(
        'Error al Procesar Archivo',
        `‚ùå ${error.message || 'Error desconocido'}\n\nIntenta nuevamente o verifica tu almacenamiento disponible.`
      );
    }
  },

  // Compartir archivo usando el sistema - CORREGIDO
  shareFile: async (fileUri, fileName = 'reporte') => {
    try {
      const canShare = await Sharing.isAvailableAsync();
      
      if (canShare) {
        console.log('üì§ Compartiendo archivo:', fileName);
        
        await Sharing.shareAsync(fileUri, {
          mimeType: 'application/octet-stream',
          dialogTitle: `Compartir ${fileName}`,
          UTI: 'public.item', // Para iOS
        });
        
        console.log('‚úÖ Archivo compartido exitosamente');
      } else {
        Alert.alert(
          'Compartir No Disponible',
          'La funci√≥n de compartir no est√° disponible en este dispositivo.\n\nEl archivo est√° guardado en tu dispositivo.'
        );
      }
    } catch (error) {
      console.error('‚ùå Error sharing file:', error);
      Alert.alert(
        'Error al Compartir',
        'No se pudo compartir el archivo, pero est√° guardado en tu dispositivo.'
      );
    }
  },

  // Mostrar informaci√≥n de ubicaci√≥n del archivo - CORREGIDO
  showFileLocation: (fileUri, isPublic = false) => {
    const message = isPublic 
      ? 'üì± El archivo se guard√≥ en la galer√≠a de tu tel√©fono.\n\nüìÅ Ubicaci√≥n:\nGaler√≠a > √Ålbumes > "Cat√°logo Ropa - Reportes"\n\nüí° Tambi√©n aparecer√° en tu aplicaci√≥n de archivos en la secci√≥n de descargas.'
      : `üìÅ El archivo se guard√≥ en:\n${fileUri}\n\nüí° Puedes encontrarlo en la carpeta de documentos de la aplicaci√≥n.\n\nUsa el bot√≥n "Compartir" para enviarlo por WhatsApp, email, etc.`;
      
    Alert.alert(
      'Ubicaci√≥n del Archivo',
      message,
      [{ text: 'Entendido', style: 'default' }]
    );
  },

  // Obtener reportes disponibles
  getAvailableReports: async () => {
    try {
      const response = await api.get('/reports/available');
      return response.data;
    } catch (error) {
      console.error('‚ùå Error getting available reports:', error);
      throw error;
    }
  },

  // Limpiar archivos antiguos - CORREGIDO
  cleanOldReports: async () => {
    try {
      console.log('üßπ Limpiando reportes antiguos...');
      const downloadDir = await reportService.getDownloadDirectory();
      
      const dirInfo = await FileSystem.getInfoAsync(downloadDir);
      if (!dirInfo.exists) {
        return;
      }
      
      const files = await FileSystem.readDirectoryAsync(downloadDir);
      
      const reportFiles = files.filter(file => 
        file.endsWith('.pdf') || file.endsWith('.xlsx')
      );
      
      // Mantener solo los √∫ltimos 10 reportes
      if (reportFiles.length > 10) {
        const filesToDelete = reportFiles
          .slice(0, reportFiles.length - 10);
        
        for (const file of filesToDelete) {
          try {
            await FileSystem.deleteAsync(downloadDir + file);
            console.log('üóëÔ∏è Archivo eliminado:', file);
          } catch (error) {
            console.error('‚ùå Error eliminando archivo:', file, error);
          }
        }
        
        console.log(`üßπ Limpieza completada: ${filesToDelete.length} archivos eliminados`);
      }
      
    } catch (error) {
      console.error('‚ùå Error cleaning old reports:', error);
    }
  },

  // Obtener estad√≠sticas de almacenamiento
  getStorageStats: async () => {
    try {
      const downloadDir = await reportService.getDownloadDirectory();
      const dirInfo = await FileSystem.getInfoAsync(downloadDir);
      
      if (!dirInfo.exists) {
        return { totalFiles: 0, totalSize: 0 };
      }
      
      const files = await FileSystem.readDirectoryAsync(downloadDir);
      let totalSize = 0;
      
      for (const file of files) {
        try {
          const fileInfo = await FileSystem.getInfoAsync(downloadDir + file);
          if (fileInfo.exists) {
            totalSize += fileInfo.size || 0;
          }
        } catch (error) {
          console.log('Error getting file info:', file);
        }
      }
      
      return {
        totalFiles: files.length,
        totalSize,
        totalSizeMB: totalSize / (1024 * 1024),
        directory: downloadDir,
      };
    } catch (error) {
      console.error('Error getting storage stats:', error);
      return { totalFiles: 0, totalSize: 0 };
    }
  },
};